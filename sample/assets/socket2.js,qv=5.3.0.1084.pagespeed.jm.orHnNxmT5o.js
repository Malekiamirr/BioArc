var worker=new Worker("/theme/custom/js/sw.js");function bio_socket(initial_port,initial_key){worker.postMessage({type:'init',hostname:get_socket_host_name(),port:initial_port,key:initial_key});worker.addEventListener("message",function(e){if(e.data.type==='open'){$('#connection_status').removeClass('avatar-online');$('#connection_status').removeClass('avatar-away');$('#connection_status').addClass('avatar-busy');}else if(e.data.type==='message'){var obj=JSON.parse(e.data.data);if(obj['type']==='reply'){var d=new Date();var n=d.getTime()-parseInt(obj['time']);}else if(obj['type']==='hello'){console.log(e.data.data);worker.postMessage({type:'initial_key'});}else if(obj['type']==='welcome'){console.log(e.data.data);if(typeof submit_localStorages==="function"){send_message('submit_localStorages','',1);}}else{console.log(e.data.data);}if(obj['type']==='pos_success_pay'){if($(location).attr('pathname')=="/calendar"||$(location).attr('pathname')=='/cashregister/index'){swal.close();setTimeout(function(){swal({title:(global_lang=='en'?'Success Payment':'خطا در پرداخت'),text:(global_lang=='en'?'Payment Success!':'پرداحت با موفقیت انجام شد'),type:"success",confirmButtonText:(global_lang=='en'?'OK':'تایید')},function(){});},1500);}}else if(obj['type']==='pos_failed_pay'){if($(location).attr('pathname')=="/calendar"||$(location).attr('pathname')=='/cashregister/index'){swal.close();setTimeout(function(){swal({title:(global_lang=='en'?'Error Payment':'خطا در پرداخت'),text:(global_lang=='en'?'Payment Failed!':'پرداحت ناموفق'),type:"error",confirmButtonText:(global_lang=='en'?'OK':'تایید')},function(){});},1500);}}$('#connection_status').addClass('avatar-online');$('#connection_status').removeClass('avatar-away');$('#connection_status').removeClass('avatar-busy');if(obj['type']==='online_visit'){if(typeof obj['sub_type']!=='undefined'&&typeof obj['message']!=='undefined'){if(obj['sub_type']=='message'){updateVisitOnlineMessages(obj['message']);}else if(obj['sub_type']=='document'){updateVisitOnlineDocuments(obj['message']);}else if(obj['sub_type']=='remove_document'){updateVisitOnlineRemoveDocuments(obj['message']);}}if($('.change_hash_'+obj['hash']).length>0){$('.change_hash_'+obj['hash']).removeClass('patient_is_online');$('#hash_'+obj['hash']+' .extra_btn_div > .online_visit').removeClass('active');setTimeout(function(){$('.change_hash_'+obj['hash']).addClass('patient_is_online');$('#hash_'+obj['hash']+' .extra_btn_div > .online_visit').addClass('active');},100);}}else if(obj['type']==='success_payment'){console.log("success pay");$('.Factor_'+obj['id']+' .btn-grey').removeClass('btn-grey').addClass('btn-success');$('.Factor_'+obj['id']+' .action_btn').remove();$('.Factor_'+obj['id']+' .btn-success').text((global_lang=='en'?'Paid: ('+obj['data']+' Rials)':'پرداخت شده: ('+obj['data']+' ریال)'));}else if(obj['type']==='sync_visit'){lastsend=new Date();let data=obj['id'].split(",");data[3]=decodeURIComponent(data[3]);let items=data[0].split('|');let id=items[0].ReplaceAll('#','');let hash=$(items[0]).closest('form').data('hash');let firstparts=items[0].split(' ');let parts=firstparts[0].split('_');if(parts.length>2&&parts[parts.length-1].length==32){hash=parts[parts.length-2]+'_'+parts[parts.length-1];if($('#hash_'+hash).length==0){get_hash_form(hash,1,0,0);initial_render_visit(hash,0);}}if($(items[0]).length!=0){if(data[2]=='checkbox'){if(data[3]==='1'){$(data[0]).prop("checked",true);}else{$(data[0]).prop("checked",false);}if(typeof change_sub_checkbox==="function"){change_sub_checkbox($(data[0]));}if(typeof tab_pane_checkbox==="function"){tab_pane_checkbox($(data[0]));}set_field_for_localstorage(hash,id);serialize_visit_info(hash,0);}else if(data[2]=='radiobox'||data[2]=='radio'){$(data[0]).prop("checked",true);}else if(data[1]=='textarea'||data[2]=='text'){if(!$(data[0]).is(":focus")){$(data[0]).val(data[3]);if(changed_items[hash]==null){changed_items[hash]=[];}if(changed_items[hash][id]==null){changed_items[hash][id]=1;}serialize_visit_info(hash,0);}}else if(data[1]=='delete_item'){$(data[0]).hide('slow').remove();}else if(data[1]=='update_item'){$(data[0]).replaceWith(data[3]).show('slow');}else if(data[1]=='update_html'){$(data[0]).html(data[3]).show('slow');}else if(data[1]=='remove_append'){$(items[1]).hide('slow').remove();$(items[0]).append(data[3]).show('slow');}else if(data[1]=='append_item'){$(data[0]).append(data[3]).show('slow');}else if(data[1]=='show_item'){$(data[0]).show('slow');}else if(data[1]=='hide_item'){$(data[0]).hide('slow');}}if(hash!=null&&hash.length>0){past_history[hash]=0;}lastsend=new Date();}else if(obj['type']==='refresh_calendar'&&typeof refresh_calendar==="function"){refresh_calendar();}else if(obj['type']==='ai_suggestion'){if(obj['data'].trim()!=''){$('#ai_suggestion_'+obj['id']).show();$('#ai_suggestion_'+obj['id']+' .main_div').html(obj['data']);$('#ai_suggestion_'+obj['id']+' .main_div .durg_suggestion').hide();$('#ai_suggestion_'+obj['id']+' .main_div .durg_suggestion').show().effect('highlight');}else{$('#ai_suggestion_'+obj['id']).hide();}}else if(obj['type']==='lightpenrefresh'&&typeof lightpenrefresh==="function"){let data=obj['id'].split(",");past_history[data[0]]=0;lightpenrefresh(data[0],data[1],$('body').data('dir'));}else if(obj['type']==='update_patient_list'&&typeof update_patient_list==="function"){update_patient_list();}else if(obj['type']==='force_submit_visit'&&typeof serialize_all_visit_info==="function"){update_patient_list(1);}else if(obj['type']==='submit_localStorages'&&typeof submit_localStorages==="function"){submit_localStorages(1,0);}else if(obj['type']==='update_visit'&&typeof update_visit==="function"){if($('#patient_list').length!=0){let show=0;if($('#hash_'+obj.data).length>0){if(!$('#hash_'+obj.data).is(":visible")){$('#hash_'+obj.data).remove();}}else{past_history[obj.data]=0;update_history(obj.data,0);}}}else if(obj['type']==='update_history'&&typeof update_history==="function"){past_history[obj.data]=0;}else if(obj['type']==='update_panel'&&typeof update_panel==="function"){update_panel();}}else if(e.data.type==='close'){if(e.data.wasClean){console.log('[close] Connection closed cleanly, code='+e.data.code+' reason='+e.data.reason);}else{console.log('[close] Connection died');}$('#connection_status').removeClass('avatar-online');$('#connection_status').removeClass('avatar-busy');$('#connection_status').addClass('avatar-away');}else if(e.data.type==='error'){console.log(e.data.message);$('#connection_status').removeClass('avatar-online');$('#connection_status').removeClass('avatar-away');$('#connection_status').addClass('avatar-busy');}else if(e.data.type==='ajax'){$.ajax({url:e.data.url,}).done(function(data){worker.postMessage({type:'initial_key',hostname:window.location.hostname,port:initial_port,key:initial_key});});}},false);}var lastsend=new Date();function send_message(type,id,force=0,hash=false){var time=new Date();var dif=time.getTime()-lastsend.getTime();if($('#connection_status').hasClass('avatar-online')&&(dif>100||force===1)){lastsend=time;let worker_message={type:'post',datatype:type,dataid:id,};if(hash!==false){worker_message['hash']=hash;}worker.postMessage(worker_message);}}